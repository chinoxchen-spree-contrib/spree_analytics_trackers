<% if segment_enabled? && @order.present? && order_just_completed?(@order) %>
  <% order_json = SpreeAnalyticsTrackers::Segment::OrderPresenter.new(@order).to_json %>
  <script>
    window.addEventListener('turbolinks:load', function() {
      if (typeof analytics !== 'undefined') {
        <% if user = try_spree_current_user %>
          analytics.identify('user.id', {
            email: 'user.email'
          });
        <% end %>
        analytics.track('Order Completed', <%= order_json.html_safe %>);
        analytics.page('Order Completed', <%= order_json.html_safe %>);
      }
    });
  </script>
<% end %>
