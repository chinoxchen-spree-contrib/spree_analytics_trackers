<% if segment_enabled? %>
  <script>

    let getUserCookie = function (name) {
      var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      if (match) {
          return decodeURIComponent(match[2]);
      } else {
          return '';
      }
    }

    if (typeof analytics !== 'undefined') {
      analytics.page();
      <% if current_order.present? %>
        if (!!getUserCookie('user_id')) {
          const traits = {
            email: !!getCookie('user_email') ? getCookie('user_email') : '',
            name: !!getCookie('name') ? getCookie('name') : '',
            phone: !!getCookie('phone') ? getCookie('phone') : '',
            total: '<%= current_order.total %>'
        }
        <% end %>
      analytics.identify(getUserCookie('user_id'), traits);
      }

      window.addEventListener('turbolinks:load', function() {
        window.readyToSegment = true;
      });
    }
  </script>
<% end %>