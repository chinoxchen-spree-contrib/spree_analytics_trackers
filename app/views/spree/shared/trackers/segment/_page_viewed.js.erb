<% if segment_enabled? %>
  <script>

    let getUserCookie = function (name) {
      var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      if (match) {
          return decodeURIComponent(match[2]);
      } else {
          return '';
      }
    }

    if (typeof analytics !== 'undefined') {
      analytics.page();

      if (!!getUserCookie('user_id')) {
        <% user_address = spree_current_user&.addresses&.last %>
        <% if current_order.present? %>
          const traits = {
            email: '<%= spree_current_user&.email %>',
            name: '<%= user_address&.full_name %>',
            phone: '<%= user_address&.phone %>',
            total: '<%= current_order.total %>',
            cart: [
              <% current_order.line_items.each do |item| %>
                {
                  name: '<%= item.name %>',
                  price: '<%= item.price %>',
                  product_id: '<%= item.id %>',
                  url: '<%= product_url(item.variant) %>',
                  image: '<%= img_cdn_url(item.variant.images.first, 400, 400) %>',
                },
              <% end %>
            ]
          }
        <% end %>
        analytics.identify(getUserCookie('user_id'), traits);
      }

      window.addEventListener('turbolinks:load', function() {
        window.readyToSegment = true;
      });
    }
  </script>
<% end %>